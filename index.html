<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 用戶綁定</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://static.line-scdn.net;
        connect-src 'self' https://script.google.com https://script.googleapis.com https://api.line.me;
    ">
    <style>
        body { margin: 0; padding: 20px; text-align: center; font-family: sans-serif; }
        .status { margin-top: 20px; }
        .success { color: green; }
        .error { color: red; }
        .loading { color: blue; }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div id="status" class="status"></div>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby074u33BFOclcfAp74nO2_fF4i4xHjAJp5Z7b6g1hfYFiMxq4TyX1KWuk_iIq6tsNBEg/exec';
        const LIFF_ID = '2008276630-bYNjwMx7';
        const MAX_RETRIES = 3;

        function setStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        async function initializeLiffAndBindUser() {
            let retryCount = 0;
            while (retryCount < MAX_RETRIES) {
                try {
                    console.log('Initializing LIFF with ID:', LIFF_ID);
                    if (!window.liff) throw new Error('LIFF SDK not loaded');
                    await window.liff.init({ liffId: LIFF_ID });
                    console.log('LIFF initialized successfully');

                    if (!window.liff.isLoggedIn()) {
                        console.log('User not logged in, redirecting to LINE login');
                        window.liff.login();
                        return;
                    }

                    setStatus('正在連結...', 'loading');
                    console.log('Fetching LINE user profile');
                    const profile = await window.liff.getProfile();
                    console.log('LINE profile received:', JSON.stringify(profile));

                    if (!profile || !profile.userId || typeof profile.userId !== 'string') {
                        throw new Error('Invalid LINE user profile or missing userId');
                    }

                    const payload = {
                        source: 'line_web_app',
                        customerName: profile.displayName || '',
                        customerLineId: profile.userId,
                        pictureUrl: profile.pictureUrl || ''
                    };
                    console.log('Sending POST request with payload:', JSON.stringify(payload));

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        redirect: 'follow'
                    });
                    console.log('POST response status:', response.status);

                    const responseText = await response.text();
                    console.log('POST response text:', responseText);
                    if (!response.ok) {
                        console.error('POST request failed:', responseText);
                        throw new Error(`Server responded with status: ${response.status} - ${responseText}`);
                    }

                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Failed to parse response:', parseError.message);
                        throw new Error('Invalid response format from server');
                    }
                    console.log('POST response data:', JSON.stringify(result));

                    if (result.status !== 'success') {
                        throw new Error(result.message || 'Backend processing failed');
                    }

                    setStatus('帳號連結成功！', 'success');
                    return;
                } catch (error) {
                    retryCount++;
                    console.warn(`Attempt ${retryCount} failed: ${error.message}`);
                    if (retryCount >= MAX_RETRIES) {
                        console.error('LIFF initialization or binding failed after max retries:', error.message);
                        setStatus('帳號連結失敗：' + (error.message || '請稍後再試'), 'error');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
                }
            }
        }

        initializeLiffAndBindUser();
    </script>
</body>
</html>
