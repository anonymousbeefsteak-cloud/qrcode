<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å°åƒåº— - LINEè¨‚é¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ¨£å¼ï¼Œå°ˆæ³¨æ–¼åŠŸèƒ½ä¿®å¾© */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft JhengHei'; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 15px; }
        .container { max-width: 400px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; }
        .header { background: #00C300; color: white; padding: 20px; text-align: center; }
        .order-form { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px; border: 2px solid #E1E8ED; border-radius: 8px; 
        }
        .readonly-field { background-color: #f5f5f5; color: #6C757D; cursor: not-allowed; }
        .user-info { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .debug-panel { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸœ å°ç£å°åƒåº—</h1>
            <p>LINE å¿«é€Ÿè¨‚é¤</p>
        </div>
        
        <div class="order-form">
            <!-- LINE ç”¨æˆ¶è³‡è¨Š -->
            <div class="user-info" id="userInfo">
                ğŸ”„ è¼‰å…¥ LINE è³‡è¨Šä¸­...
            </div>
            
            <!-- é™¤éŒ¯è³‡è¨Š -->
            <div class="debug-panel" id="debugPanel">
                <strong>ç³»çµ±ç‹€æ…‹:</strong> åˆå§‹åŒ–ä¸­...
            </div>
            
            <!-- é¡§å®¢è³‡è¨Š -->
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="customerName" class="readonly-field" readonly placeholder="è‡ªå‹•å¸¶å…¥ LINE åç¨±">
            </div>
            
            <div class="form-group">
                <label>LINE User ID</label>
                <input type="text" id="customerLineId" class="readonly-field" readonly placeholder="è‡ªå‹•å¸¶å…¥ LINE User ID">
            </div>
            
            <!-- å…¶ä»–è¡¨å–®æ¬„ä½ä¿æŒä¸è®Š -->
            <div class="form-group">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
                <input type="tel" id="customerPhone" placeholder="0912345678" required>
            </div>
            
            <!-- èœå–®é¸æ“‡ç­‰å…¶ä»–å…§å®¹ -->
        </div>
    </div>

    <script>
        // ç³»çµ±é…ç½®
        const CONFIG = {
            LIFF_ID: '2008289130-9XPR8Kpj'
        };
        
        let userProfile = null;
        
        // æ›´æ–°é™¤éŒ¯è³‡è¨Š
        function updateDebugInfo(message) {
            document.getElementById('debugPanel').innerHTML = `<strong>ç³»çµ±ç‹€æ…‹:</strong> ${message}`;
            console.log('DEBUG:', message);
        }
        
        // å¼·åŒ– LIFF åˆå§‹åŒ–
        async function initializeLiffWithRetry(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                updateDebugInfo(`åˆå§‹åŒ– LIFF... (å˜—è©¦ ${retryCount + 1}/${maxRetries})`);
                
                // åˆå§‹åŒ– LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });
                updateDebugInfo('LIFF åˆå§‹åŒ–æˆåŠŸ');
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (liff.isLoggedIn()) {
                    updateDebugInfo('ç”¨æˆ¶å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶è³‡æ–™...');
                    await loadUserProfile();
                } else {
                    updateDebugInfo('ç”¨æˆ¶æœªç™»å…¥ï¼Œå˜—è©¦è‡ªå‹•ç™»å…¥...');
                    
                    // åœ¨æ­¡è¿è¨Šæ¯æƒ…å¢ƒä¸­ï¼Œé€šå¸¸æ‡‰è©²å·²ç¶“ç™»å…¥
                    // å¦‚æœæœªç™»å…¥ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œ
                    if (retryCount < maxRetries) {
                        setTimeout(() => initializeLiffWithRetry(retryCount + 1), 1000);
                    } else {
                        updateDebugInfo('è‡ªå‹•ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                        showError('è«‹é‡æ–°æ•´ç†é é¢æˆ–è¯ç¹«å®¢æœ');
                    }
                }
                
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
                updateDebugInfo(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                
                if (retryCount < maxRetries) {
                    updateDebugInfo(`${1000 * (retryCount + 1)}ms å¾Œé‡è©¦...`);
                    setTimeout(() => initializeLiffWithRetry(retryCount + 1), 1000 * (retryCount + 1));
                } else {
                    updateDebugInfo('æ‰€æœ‰é‡è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID è¨­å®š');
                    showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹è¯ç¹«å®¢æœ');
                }
            }
        }
        
        // è¼‰å…¥ç”¨æˆ¶è³‡æ–™ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        async function loadUserProfile() {
            try {
                updateDebugInfo('æ­£åœ¨ç²å–ç”¨æˆ¶å€‹äººè³‡æ–™...');
                
                // ç²å–ç”¨æˆ¶è³‡æ–™
                userProfile = await liff.getProfile();
                updateDebugInfo(`ç”¨æˆ¶è³‡æ–™ç²å–æˆåŠŸ: ${userProfile.displayName}`);
                
                // æ›´æ–° UI
                updateUserInfoUI();
                
                // ç²å–å…¶ä»–ä¸Šä¸‹æ–‡è³‡è¨Š
                const context = liff.getContext();
                updateDebugInfo(`ä¸Šä¸‹æ–‡é¡å‹: ${context.type}, LIFF ID: ${context.liffId}`);
                
            } catch (error) {
                console.error('ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
                updateDebugInfo(`ç”¨æˆ¶è³‡æ–™ç²å–å¤±æ•—: ${error.message}`);
                
                // å˜—è©¦ä½¿ç”¨å‚™ç”¨æ–¹æ³•
                try {
                    updateDebugInfo('å˜—è©¦å‚™ç”¨æ–¹æ³•ç²å–ç”¨æˆ¶è³‡è¨Š...');
                    await tryAlternativeMethods();
                } catch (fallbackError) {
                    updateDebugInfo('æ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—');
                    showError('ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Šï¼Œè«‹è¯ç¹«å®¢æœ');
                }
            }
        }
        
        // æ›´æ–°ç”¨æˆ¶è³‡è¨Šåˆ° UI
        function updateUserInfoUI() {
            if (userProfile) {
                // æ›´æ–°å”¯è®€æ¬„ä½
                document.getElementById('customerName').value = userProfile.displayName;
                document.getElementById('customerLineId').value = userProfile.userId;
                
                // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
                document.getElementById('userInfo').innerHTML = 
                    `âœ… æ­¡è¿ï¼Œ${userProfile.displayName}ï¼LINE ç¶å®šæˆåŠŸ`;
                
                updateDebugInfo(`UI æ›´æ–°å®Œæˆ: ${userProfile.displayName} (${userProfile.userId})`);
            }
        }
        
        // å‚™ç”¨æ–¹æ³•ç²å–ç”¨æˆ¶è³‡è¨Š
        async function tryAlternativeMethods() {
            try {
                // æ–¹æ³• 1: å˜—è©¦ä½¿ç”¨ liff.getProfile() çš„ä¸åŒå‘¼å«æ–¹å¼
                updateDebugInfo('å˜—è©¦æ–¹æ³• 1: ç›´æ¥å‘¼å« getProfile...');
                const profile = await liff.getProfile();
                if (profile) {
                    userProfile = profile;
                    updateUserInfoUI();
                    return;
                }
            } catch (e) {
                updateDebugInfo(`æ–¹æ³• 1 å¤±æ•—: ${e.message}`);
            }
            
            try {
                // æ–¹æ³• 2: æª¢æŸ¥æ˜¯å¦æœ‰éƒ¨åˆ†è³‡è¨Šå¯ç”¨
                updateDebugInfo('å˜—è©¦æ–¹æ³• 2: æª¢æŸ¥åŸºæœ¬è³‡è¨Š...');
                if (liff.isLoggedIn()) {
                    // å³ä½¿ getProfile å¤±æ•—ï¼Œæˆ‘å€‘ä»ç„¶çŸ¥é“ç”¨æˆ¶å·²ç™»å…¥
                    document.getElementById('userInfo').innerHTML = 
                        `âš ï¸ æ­¡è¿ä½¿ç”¨è¨‚é¤æœå‹™ï¼`;
                    document.getElementById('customerName').placeholder = 'è«‹æ‰‹å‹•è¼¸å…¥å§“å';
                    document.getElementById('customerLineId').placeholder = 'ç³»çµ±è‡ªå‹•è¨˜éŒ„';
                }
            } catch (e) {
                updateDebugInfo(`æ–¹æ³• 2 å¤±æ•—: ${e.message}`);
            }
        }
        
        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            document.getElementById('userInfo').innerHTML = `âŒ ${message}`;
            document.getElementById('userInfo').style.background = '#FFEAA7';
        }
        
        // é é¢è¼‰å…¥åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // æª¢æŸ¥ LIFF SDK æ˜¯å¦è¼‰å…¥
            if (typeof liff === 'undefined') {
                updateDebugInfo('LIFF SDK æœªè¼‰å…¥ï¼Œç­‰å¾…è¼‰å…¥...');
                // ç­‰å¾… SDK è¼‰å…¥
                const checkSDK = setInterval(() => {
                    if (typeof liff !== 'undefined') {
                        clearInterval(checkSDK);
                        initializeLiffWithRetry();
                    }
                }, 100);
            } else {
                initializeLiffWithRetry();
            }
        });
        
        // æ·»åŠ é‡è©¦æŒ‰éˆ•åŠŸèƒ½
        function retryInitialization() {
            updateDebugInfo('æ‰‹å‹•é‡è©¦åˆå§‹åŒ–...');
            initializeLiffWithRetry();
        }
    </script>
</body>
</html>
