// ğŸ”¥ ç«‹å³ä¿®å¾©ç‰ˆ - è‡ªå‹•å»ºç«‹ Sheet
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const userId = data.userId;
    const displayName = data.displayName;
    const pictureUrl = data.pictureUrl || '';

    if (!userId) {
      return ContentService.createTextOutput(JSON.stringify({ 
        success: false, 
        message: 'ç¼ºå°‘ userId' 
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // ğŸ”¥ è‡ªå‹•å»ºç«‹æˆ–å–å¾— Sheet
    let sheet;
    try {
      sheet = SpreadsheetApp.openById('1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms').getActiveSheet();
    } catch (e) {
      // å¦‚æœæ²’æœ‰ Sheetï¼Œè‡ªå‹•å»ºç«‹æ–°çš„ä¸€å€‹
      const ss = SpreadsheetApp.create('ç„¡åç‰›æ’æœƒå“¡è³‡æ–™');
      sheet = ss.getActiveSheet();
      sheet.getRange(1, 1, 1, 4).setValues([['æ™‚é–“æˆ³è¨˜', 'User ID', 'å§“å', 'é ­åƒ URL']]);
    }
    
    // è¨­å®šæ¨™é¡Œï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 4).setValues([['æ™‚é–“æˆ³è¨˜', 'User ID', 'å§“å', 'é ­åƒ URL']]);
    }

    // æª¢æŸ¥é‡è¤‡
    const dataRange = sheet.getDataRange();
    if (dataRange.getNumRows() > 1) {
      const existingData = dataRange.getValues();
      const userExists = existingData.slice(1).some(row => row[1] === userId);
      if (userExists) {
        return ContentService.createTextOutput(JSON.stringify({ 
          success: true, 
          message: 'ç”¨æˆ¶å·²å­˜åœ¨' 
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }

    // ğŸ”¥ æ–°å¢è³‡æ–™
    const timestamp = new Date();
    sheet.appendRow([timestamp, userId, displayName, pictureUrl]);

    return ContentService.createTextOutput(JSON.stringify({ 
      success: true, 
      message: 'è¨˜éŒ„åˆ°æœƒå“¡è³‡æ–™åº«æˆåŠŸï¼' 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // ğŸ”¥ è©³ç´°éŒ¯èª¤è¨˜éŒ„
    console.log('éŒ¯èª¤è©³æƒ…:', error);
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      message: 'ç¶²è·¯éŒ¯èª¤ï¼š' + error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet() {
  return ContentService.createTextOutput('å¾Œç«¯æ­£å¸¸');
}
