<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣小吃店 - LINE訂餐</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* 保持原有樣式，專注於功能修復 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft JhengHei'; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 15px; }
        .container { max-width: 400px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; }
        .header { background: #00C300; color: white; padding: 20px; text-align: center; }
        .order-form { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px; border: 2px solid #E1E8ED; border-radius: 8px; 
        }
        .readonly-field { background-color: #f5f5f5; color: #6C757D; cursor: not-allowed; }
        .user-info { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .debug-panel { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍜 台灣小吃店</h1>
            <p>LINE 快速訂餐</p>
        </div>
        
        <div class="order-form">
            <!-- LINE 用戶資訊 -->
            <div class="user-info" id="userInfo">
                🔄 載入 LINE 資訊中...
            </div>
            
            <!-- 除錯資訊 -->
            <div class="debug-panel" id="debugPanel">
                <strong>系統狀態:</strong> 初始化中...
            </div>
            
            <!-- 顧客資訊 -->
            <div class="form-group">
                <label>姓名</label>
                <input type="text" id="customerName" class="readonly-field" readonly placeholder="自動帶入 LINE 名稱">
            </div>
            
            <div class="form-group">
                <label>LINE User ID</label>
                <input type="text" id="customerLineId" class="readonly-field" readonly placeholder="自動帶入 LINE User ID">
            </div>
            
            <!-- 其他表單欄位保持不變 -->
            <div class="form-group">
                <label>手機號碼</label>
                <input type="tel" id="customerPhone" placeholder="0912345678" required>
            </div>
            
            <!-- 菜單選擇等其他內容 -->
        </div>
    </div>

    <script>
        // 系統配置
        const CONFIG = {
            LIFF_ID: '2008289130-9XPR8Kpj'
        };
        
        let userProfile = null;
        
        // 更新除錯資訊
        function updateDebugInfo(message) {
            document.getElementById('debugPanel').innerHTML = `<strong>系統狀態:</strong> ${message}`;
            console.log('DEBUG:', message);
        }
        
        // 強化 LIFF 初始化
        async function initializeLiffWithRetry(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                updateDebugInfo(`初始化 LIFF... (嘗試 ${retryCount + 1}/${maxRetries})`);
                
                // 初始化 LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });
                updateDebugInfo('LIFF 初始化成功');
                
                // 檢查登入狀態
                if (liff.isLoggedIn()) {
                    updateDebugInfo('用戶已登入，獲取用戶資料...');
                    await loadUserProfile();
                } else {
                    updateDebugInfo('用戶未登入，嘗試自動登入...');
                    
                    // 在歡迎訊息情境中，通常應該已經登入
                    // 如果未登入，可能是權限問題
                    if (retryCount < maxRetries) {
                        setTimeout(() => initializeLiffWithRetry(retryCount + 1), 1000);
                    } else {
                        updateDebugInfo('自動登入失敗，請重新整理頁面');
                        showError('請重新整理頁面或聯繫客服');
                    }
                }
                
            } catch (error) {
                console.error('LIFF 初始化錯誤:', error);
                updateDebugInfo(`初始化失敗: ${error.message}`);
                
                if (retryCount < maxRetries) {
                    updateDebugInfo(`${1000 * (retryCount + 1)}ms 後重試...`);
                    setTimeout(() => initializeLiffWithRetry(retryCount + 1), 1000 * (retryCount + 1));
                } else {
                    updateDebugInfo('所有重試失敗，請檢查 LIFF ID 設定');
                    showError('系統初始化失敗，請聯繫客服');
                }
            }
        }
        
        // 載入用戶資料（強化版）
        async function loadUserProfile() {
            try {
                updateDebugInfo('正在獲取用戶個人資料...');
                
                // 獲取用戶資料
                userProfile = await liff.getProfile();
                updateDebugInfo(`用戶資料獲取成功: ${userProfile.displayName}`);
                
                // 更新 UI
                updateUserInfoUI();
                
                // 獲取其他上下文資訊
                const context = liff.getContext();
                updateDebugInfo(`上下文類型: ${context.type}, LIFF ID: ${context.liffId}`);
                
            } catch (error) {
                console.error('獲取用戶資料失敗:', error);
                updateDebugInfo(`用戶資料獲取失敗: ${error.message}`);
                
                // 嘗試使用備用方法
                try {
                    updateDebugInfo('嘗試備用方法獲取用戶資訊...');
                    await tryAlternativeMethods();
                } catch (fallbackError) {
                    updateDebugInfo('所有方法都失敗');
                    showError('無法獲取用戶資訊，請聯繫客服');
                }
            }
        }
        
        // 更新用戶資訊到 UI
        function updateUserInfoUI() {
            if (userProfile) {
                // 更新唯讀欄位
                document.getElementById('customerName').value = userProfile.displayName;
                document.getElementById('customerLineId').value = userProfile.userId;
                
                // 更新用戶資訊顯示
                document.getElementById('userInfo').innerHTML = 
                    `✅ 歡迎，${userProfile.displayName}！LINE 綁定成功`;
                
                updateDebugInfo(`UI 更新完成: ${userProfile.displayName} (${userProfile.userId})`);
            }
        }
        
        // 備用方法獲取用戶資訊
        async function tryAlternativeMethods() {
            try {
                // 方法 1: 嘗試使用 liff.getProfile() 的不同呼叫方式
                updateDebugInfo('嘗試方法 1: 直接呼叫 getProfile...');
                const profile = await liff.getProfile();
                if (profile) {
                    userProfile = profile;
                    updateUserInfoUI();
                    return;
                }
            } catch (e) {
                updateDebugInfo(`方法 1 失敗: ${e.message}`);
            }
            
            try {
                // 方法 2: 檢查是否有部分資訊可用
                updateDebugInfo('嘗試方法 2: 檢查基本資訊...');
                if (liff.isLoggedIn()) {
                    // 即使 getProfile 失敗，我們仍然知道用戶已登入
                    document.getElementById('userInfo').innerHTML = 
                        `⚠️ 歡迎使用訂餐服務！`;
                    document.getElementById('customerName').placeholder = '請手動輸入姓名';
                    document.getElementById('customerLineId').placeholder = '系統自動記錄';
                }
            } catch (e) {
                updateDebugInfo(`方法 2 失敗: ${e.message}`);
            }
        }
        
        // 顯示錯誤訊息
        function showError(message) {
            document.getElementById('userInfo').innerHTML = `❌ ${message}`;
            document.getElementById('userInfo').style.background = '#FFEAA7';
        }
        
        // 頁面載入初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo('頁面載入完成，開始初始化...');
            
            // 檢查 LIFF SDK 是否載入
            if (typeof liff === 'undefined') {
                updateDebugInfo('LIFF SDK 未載入，等待載入...');
                // 等待 SDK 載入
                const checkSDK = setInterval(() => {
                    if (typeof liff !== 'undefined') {
                        clearInterval(checkSDK);
                        initializeLiffWithRetry();
                    }
                }, 100);
            } else {
                initializeLiffWithRetry();
            }
        });
        
        // 添加重試按鈕功能
        function retryInitialization() {
            updateDebugInfo('手動重試初始化...');
            initializeLiffWithRetry();
        }
    </script>
</body>
</html>
