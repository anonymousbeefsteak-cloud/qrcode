<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 二維碼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configure Tailwind colors and fonts -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00C300', // LINE brand green
                        secondary: '#F5F5F5',
                        dark: '#333333'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- Custom utility classes -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .qr-shadow {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            }
        }
    </style>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Import Map for React -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';

        // LIFF ID provided in the prompt
        const LIFF_ID = '2008289130-9XPR8Kpj';

        // IMPORTANT: Replace this with your actual Google Apps Script Web App URL
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

        // Loading component displayed during initialization
        const LoadingScreen = () => (
          <div className="flex items-center justify-center h-screen bg-gray-50">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"></div>
              <p className="mt-4 text-lg text-gray-600">正在與 LINE 連接...</p>
            </div>
          </div>
        );

        // Main Application Component
        const App = () => {
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [isSuccess, setIsSuccess] = useState(false);
          const [showCopyToast, setShowCopyToast] = useState(false);

          const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
              setShowCopyToast(true);
              setTimeout(() => {
                setShowCopyToast(false);
              }, 3000);
            });
          };
          
          const sendDataToGoogleSheet = useCallback(async (profile) => {
            if (GOOGLE_APPS_SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID')) {
              console.warn('Google Apps Script URL is not set. Skipping data submission.');
              setError('後端服務尚未配置，無法記錄資料。');
              return;
            }
            try {
              const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Google Apps Script requires this for simple POSTs
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(profile),
              });
              // In no-cors mode, we can't inspect the response, so we optimistically assume success.
              setIsSuccess(true);
            } catch (e) {
              console.error('Error sending data to Google Sheet:', e);
              setError('無法將資料傳送到後端，請稍後再試。');
            }
          }, []);

          useEffect(() => {
            const initializeLiff = async () => {
              try {
                const liff = window.liff;
                if (!liff) {
                  throw new Error('LIFF SDK not found.');
                }

                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                  // If not logged in, redirect to login page.
                  // The page will be reloaded after login.
                  liff.login();
                  return;
                }

                const profile = await liff.getProfile();
                await sendDataToGoogleSheet(profile);

              } catch (e) {
                console.error('LIFF initialization failed', e);
                setError(`初始化失敗：${e.message}`);
              } finally {
                setIsLoading(false);
              }
            };

            initializeLiff();
          }, [sendDataToGoogleSheet]);

          if (isLoading) {
            return <LoadingScreen />;
          }
          
          return (
            <div className="min-h-screen flex flex-col">
              {/* Header */}
              <header className="bg-white shadow-sm">
                <div className="container mx-auto px-4 py-6 flex justify-between items-center">
                  <div className="flex items-center space-x-2">
                    <div className="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                      <i className="fa fa-comment text-white text-xl"></i>
                    </div>
                    <h1 className="text-xl md:text-2xl font-bold">LINE 二維碼</h1>
                  </div>
                  <div>
                    <button className="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition duration-300 flex items-center">
                      <i className="fa fa-share-alt mr-2"></i>分享
                    </button>
                  </div>
                </div>
              </header>

              {/* Main Content */}
              <main className="flex-grow container mx-auto px-4 py-8 md:py-16">
                <div className="max-w-3xl mx-auto">
                  {/* Title Area */}
                  <div className="text-center mb-10">
                    <h2 className="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-4">掃描二維碼加入聯繫</h2>
                    <p className="text-gray-600 text-lg">使用LINE應用程式掃描下方二維碼，立即添加為好友或加入群組</p>
                  </div>

                  {/* Status Messages */}
                  <div className="text-center mb-6">
                    {error && (
                      <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong className="font-bold">發生錯誤：</strong>
                        <span className="block sm:inline">{error}</span>
                      </div>
                    )}
                    {isSuccess && (
                      <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                        <strong className="font-bold">成功！</strong>
                        <span className="block sm:inline">感謝您的加入，您的資料已成功記錄。</span>
                      </div>
                    )}
                  </div>


                  {/* QR Code Area */}
                  <div className="bg-white rounded-xl p-6 md:p-10 qr-shadow mb-10 flex flex-col items-center">
                    <div className="relative mb-6">
                      <img 
                        src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/4e03bdf943d1443ea3ec5fa72978155a.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251011120817294D51A8FB4817821CDD&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1760760497&x-signature=sMiaEFbK7IUchDhVNcD3LSxPHU0%3D" 
                        alt="LINE二維碼" 
                        className="w-64 h-64 md:w-80 md:h-80 object-contain border-4 border-gray-100 rounded-lg"
                      />
                      <div className="absolute -top-3 -left-3 w-12 h-12 border-t-4 border-l-4 border-primary rounded-tl-lg"></div>
                      <div className="absolute -top-3 -right-3 w-12 h-12 border-t-4 border-r-4 border-primary rounded-tr-lg"></div>
                      <div className="absolute -bottom-3 -left-3 w-12 h-12 border-b-4 border-l-4 border-primary rounded-bl-lg"></div>
                      <div className="absolute -bottom-3 -right-3 w-12 h-12 border-b-4 border-r-4 border-primary rounded-br-lg"></div>
                    </div>
                    
                    <div className="text-center">
                      <p className="text-gray-700 mb-2">若無法掃描，可手動輸入ID加入</p>
                      <div className="flex items-center justify-center bg-gray-100 px-4 py-2 rounded-lg font-medium">
                        <i className="fa fa-id-card text-primary mr-2"></i>
                        <span>@561zotgq</span>
                        <button className="ml-3 text-primary hover:text-primary/80 transition" onClick={() => copyToClipboard('@561zotgq')}>
                          <i className="fa fa-copy"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  {/* Instructions */}
                  <div className="bg-white rounded-xl p-6 shadow-md">
                    <h3 className="text-xl font-bold mb-4 flex items-center">
                      <i className="fa fa-info-circle text-primary mr-2"></i>使用說明
                    </h3>
                    <ol className="space-y-4">
                      <li className="flex items-start">
                        <div className="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5 mr-3">1</div>
                        <p>打開LINE應用程式，點擊主頁的「加入好友」圖示</p>
                      </li>
                      <li className="flex items-start">
                        <div className="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5 mr-3">2</div>
                        <p>選擇「行動條碼」選項，將鏡頭對準上方二維碼</p>
                      </li>
                      <li className="flex items-start">
                        <div className="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5 mr-3">3</div>
                        <p>掃描成功後，按照提示完成添加好友的操作</p>
                      </li>
                    </ol>
                  </div>
                </div>
              </main>
              
              {/* Footer */}
              <footer className="bg-dark text-white py-6">
                <div className="container mx-auto px-4 text-center">
                  <p className="mb-2">© 2024 LINE Corporation. 保留所有權利。</p>
                  <p className="text-gray-400 text-sm">LINE是LINE Corporation的註冊商標</p>
                </div>
              </footer>
              
              {/* Copy Toast Notification */}
              <div 
                className={`fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-dark text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 ${showCopyToast ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
              >
                已複製到剪貼簿
              </div>
            </div>
          );
        }

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(
              <React.StrictMode>
                <App />
              </React.StrictMode>
            );
        }
    </script>
</body>
</html>
