
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add LINE Friend to Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://aistudiocdn.com/react@^19.2.0",
          "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
          "react/": "https://aistudiocdn.com/react@^19.2.0/"
        }
      }
    </script>
    <!-- Add Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!-- Change script type to text/babel to enable in-browser JSX transpilation -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- CONSTANTS ---
      const LIFF_ID = '2008289130-9XPR8Kpj';
      // IMPORTANT: Replace this with your actual Google Apps Script Web App URL.
      // This URL is provided when you deploy your script as a web app.
      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8BmsOqTwBRzSSwZBHtz4qS6fZytfUf59XkYi5X3fSp_ffT_HOheY1TFem3OnHjCcEGQ/exec';

      // --- COMPONENTS ---

      const LoadingSpinner = () => (
        <div className="flex flex-col items-center justify-center space-y-4">
          <svg
            className="animate-spin h-12 w-12 text-white"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              strokeWidth="4"
            ></circle>
            <path
              className="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p className="text-lg font-medium text-white">Connecting...</p>
        </div>
      );

      const UserProfileCard = ({ profile }) => {
        return (
          <div className="flex flex-col items-center justify-center animate-fade-in">
            <img
              src={profile.pictureUrl || 'https://i.pravatar.cc/150'}
              alt="LINE Profile"
              className="w-24 h-24 rounded-full border-4 border-white shadow-lg mb-4"
            />
            <p className="text-xl font-semibold">{profile.displayName}</p>
          </div>
        );
      };
      
      const CheckCircleIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );

      const ExclamationCircleIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      );
      
      const StatusMessage = ({ type, message }) => {
        const isSuccess = type === 'success';
        const bgColor = isSuccess ? 'bg-green-100/30' : 'bg-red-100/30';
        const textColor = isSuccess ? 'text-green-100' : 'text-red-200';
        const Icon = isSuccess ? CheckCircleIcon : ExclamationCircleIcon;

        return (
          <div className={`mt-6 p-4 rounded-lg flex items-center justify-center animate-fade-in ${bgColor} ${textColor}`}>
            <Icon />
            <span className="font-medium text-sm">{message}</span>
          </div>
        );
      };


      // --- MAIN APP COMPONENT ---

      const App = () => {
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [profile, setProfile] = useState(null);
        const [isAdded, setIsAdded] = useState(false);

        const addUserToSheet = useCallback(async (userProfile) => {
          if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID_HERE')) {
            setError("The Google Apps Script URL is not configured. Please contact the administrator.");
            return;
          }
          try {
            const { userId, displayName } = userProfile;
            
            // Using `fetch` with `mode: 'no-cors'` is a workaround. The request is sent,
            // but the client-side code cannot read the response from Google Apps Script.
            // For this to work, your Apps Script must be deployed to be accessible by "Anyone".
            // You can also use a proper backend proxy to handle CORS and responses gracefully.
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: JSON.stringify({ userId, displayName }),
            });

            // Since we can't read the response in 'no-cors' mode, we optimistically assume success.
            console.log('Data sent to Google Sheet.');
            setIsAdded(true);

          } catch (err) {
            console.error('Error sending data to Google Sheet:', err);
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred';
            setError(`Failed to add you to the list. Please try again later. Details: ${errorMessage}`);
          }
        }, []);

        useEffect(() => {
          const initializeLiff = async () => {
            try {
              console.log('Initializing LIFF...');
              await liff.init({ liffId: LIFF_ID });

              if (!liff.isLoggedIn()) {
                console.log('User not logged in. Redirecting to login...');
                liff.login();
                return;
              }

              console.log('User is logged in. Getting profile...');
              const userProfile = await liff.getProfile();
              setProfile(userProfile);

              console.log('Profile fetched:', userProfile);
              await addUserToSheet(userProfile);

            } catch (err) {
              console.error('LIFF Initialization Error:', err);
              const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred';
              setError(`Failed to initialize. Please make sure you are opening this in LINE. Details: ${errorMessage}`);
            } finally {
              setLoading(false);
            }
          };

          // The liff object is loaded from the external script, so we wait for it to be available.
          if (window.liff) {
            initializeLiff();
          } else {
             setError("LIFF SDK not found. Please check your internet connection and refresh the page.");
             setLoading(false);
          }
        }, [addUserToSheet]);

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-400 to-teal-600 flex flex-col items-center justify-center p-4 text-white font-sans">
            <main className="w-full max-w-md mx-auto bg-white/20 backdrop-blur-lg rounded-2xl shadow-2xl p-8 text-center">
              <h1 className="text-3xl font-bold mb-2">Welcome!</h1>
              <p className="text-lg mb-6 text-gray-200">Thanks for connecting.</p>
              
              <div className="h-48 flex items-center justify-center">
                {loading && <LoadingSpinner />}
                {error && <StatusMessage type="error" message={error} />}
                {!loading && !error && profile && (
                  <div>
                    <UserProfileCard profile={profile} />
                    {isAdded ? (
                      <StatusMessage type="success" message="You've been successfully added to our list!" />
                    ) : (
                      <p className="mt-4 text-yellow-300">Adding you to the list...</p>
                    )}
                  </div>
                )}
              </div>
            </main>
            <footer className="mt-8 text-sm text-white/70">
              <p>Powered by LIFF & Google Sheets</p>
            </footer>
          </div>
        );
      };

      // --- RENDER APP ---

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
