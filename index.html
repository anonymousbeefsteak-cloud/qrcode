<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç„¡åç‰›æ’ - LINE æœƒå“¡ç¶å®š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- ä½¿ç”¨ç©©å®šçš„ LIFF SDK ç‰ˆæœ¬ -->
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00C300',
                        secondary: '#F5F5F5',
                        dark: '#333333',
                        steak: '#8B4513'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #00C300 0%, #009900 100%);
        }
        .steak-bg {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <div id="app">
        <!-- è¼‰å…¥ç•«é¢ -->
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-gray-100">
            <div class="text-center fade-in">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2">æ­£åœ¨é€£æ¥ LINE æœå‹™</h2>
                <p class="text-gray-500">è«‹ç¨å€™...</p>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¸¸æ•¸ - ä½¿ç”¨æ‚¨æä¾›çš„æ­£ç¢º URL
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGtYFYPNb--tqZAcHYaqMscBfnP0ldxPaJ9EaO8wY4cUmztp1ZhVx8dAuWlEjF8mZPww/exec';
        const LIFF_ID = '2008289130-9XPR8Kpj';

        // åˆå§‹åŒ– LIFF æ‡‰ç”¨
        async function initializeLiff() {
            try {
                console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF æ‡‰ç”¨...');
                
                // åˆå§‹åŒ– LIFF
                await liff.init({ liffId: LIFF_ID });
                console.log('âœ… LIFF SDK åˆå§‹åŒ–æˆåŠŸ');
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!liff.isLoggedIn()) {
                    console.log('ğŸ” ç”¨æˆ¶æœªç™»å…¥ï¼ŒåŸ·è¡Œç™»å…¥...');
                    liff.login({
                        redirectUri: window.location.href
                    });
                    return;
                }
                
                console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥ LINE');
                
                // å–å¾—ç”¨æˆ¶è³‡æ–™
                console.log('ğŸ‘¤ æ­£åœ¨å–å¾—ç”¨æˆ¶è³‡æ–™...');
                const profile = await liff.getProfile();
                const context = liff.getContext();
                
                console.log('ğŸ“‹ ç”¨æˆ¶è³‡æ–™:', {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl,
                    language: context.language
                });
                
                // é¡¯ç¤ºè¼‰å…¥ä¸­çš„ç”¨æˆ¶ä»‹é¢
                showUserLoading(profile.displayName);
                
                // ç™¼é€ç”¨æˆ¶è³‡æ–™åˆ°å¾Œç«¯
                await sendUserDataToBackend(profile, context);
                
            } catch (error) {
                console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                showError('LINE æœå‹™é€£æ¥å¤±æ•—', 'è«‹ç¢ºä¿æ‚¨åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤é é¢ï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚');
            }
        }

        // ç™¼é€ç”¨æˆ¶è³‡æ–™åˆ° Google Apps Script
        async function sendUserDataToBackend(profile, context) {
            try {
                console.log('ğŸ“¤ é–‹å§‹ç™¼é€ç”¨æˆ¶è³‡æ–™åˆ°å¾Œç«¯...');
                
                const userData = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    statusMessage: profile.statusMessage || '',
                    language: context.language || 'zh-TW',
                    source: 'line_qr_code',
                    timestamp: new Date().toISOString()
                };
                
                console.log('ğŸ“¦ æº–å‚™ç™¼é€çš„è³‡æ–™:', userData);
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                console.log('ğŸ“¨ æ”¶åˆ°å¾Œç«¯å›æ‡‰ï¼Œç‹€æ…‹:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('âœ… å¾Œç«¯è™•ç†çµæœ:', result);
                
                if (result.success) {
                    showSuccess(profile, result.data);
                } else {
                    showError('è³‡æ–™è™•ç†å¤±æ•—', result.message || 'è«‹ç¨å¾Œå†è©¦');
                }
                
            } catch (error) {
                console.error('âŒ ç™¼é€ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
                showError('ç¶²è·¯é€£ç·šå•é¡Œ', 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡æ–°æ•´ç†é é¢ã€‚');
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è¼‰å…¥ä¸­ç•«é¢
        function showUserLoading(userName) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-gray-100">
                    <div class="text-center fade-in">
                        <div class="w-24 h-24 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-user text-primary text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­¡è¿ï¼Œ${userName}ï¼</h2>
                        <p class="text-gray-600 mb-6">æ­£åœ¨ç‚ºæ‚¨å»ºç«‹æœƒå“¡è³‡æ–™...</p>
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                    </div>
                </div>
            `;
        }

        // é¡¯ç¤ºæˆåŠŸç•«é¢
        function showSuccess(profile, resultData) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-gray-100">
                    <!-- é é ­ -->
                    <div class="gradient-bg text-white py-6 px-4 text-center">
                        <div class="max-w-2xl mx-auto">
                            <i class="fa fa-check-circle text-4xl mb-4"></i>
                            <h1 class="text-3xl font-bold mb-2">åŠ å…¥æˆåŠŸï¼</h1>
                            <p class="text-lg opacity-90">æ­¡è¿æˆç‚ºç„¡åç‰›æ’æœƒå“¡</p>
                        </div>
                    </div>
                    
                    <!-- ä¸»è¦å…§å®¹ -->
                    <div class="max-w-2xl mx-auto px-4 py-8">
                        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6 fade-in">
                            <div class="text-center mb-6">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fa fa-user-check text-green-600 text-2xl"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">${profile.displayName}</h2>
                                <p class="text-gray-600">æ‚¨å·²æˆåŠŸåŠ å…¥æœƒå“¡ç³»çµ±</p>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-6 mb-6">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fa fa-gift text-primary mr-2"></i>
                                    æœƒå“¡å°ˆå±¬æ¬Šç›Š
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex items-center text-gray-700">
                                        <i class="fa fa-check-circle text-green-500 mr-3"></i>
                                        <span>æ–°æœƒå“¡é¦–æ¬¡æ¶ˆè²» 9 æŠ˜å„ªæƒ </span>
                                    </div>
                                    <div class="flex items-center text-gray-700">
                                        <i class="fa fa-check-circle text-green-500 mr-3"></i>
                                        <span>å°ˆå±¬ç”Ÿæ—¥ç¦®ç‰©èˆ‡å„ªæƒ </span>
                                    </div>
                                    <div class="flex items-center text-gray-700">
                                        <i class="fa fa-check-circle text-green-500 mr-3"></i>
                                        <span>æœ€æ–°ä¿ƒéŠ·æ´»å‹•å„ªå…ˆé€šçŸ¥</span>
                                    </div>
                                    <div class="flex items-center text-gray-700">
                                        <i class="fa fa-check-circle text-green-500 mr-3"></i>
                                        <span>ç·šä¸Šè¨‚é¤å…æ’éšŠæœå‹™</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <p class="text-sm text-gray-500 mb-4">
                                    <i class="fa fa-clock mr-1"></i>
                                    åŠ å…¥æ™‚é–“: ${new Date().toLocaleString('zh-TW')}
                                </p>
                                <button onclick="closeLiff()" class="steak-bg hover:opacity-90 text-white px-8 py-3 rounded-lg transition duration-300 font-semibold">
                                    é–‹å§‹ä½¿ç”¨æœƒå“¡æœå‹™
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‡å¼• -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 fade-in" style="animation-delay: 0.2s">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-info-circle text-primary mr-2"></i>
                                ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
                            </h3>
                            <div class="space-y-3 text-sm text-gray-600">
                                <p>â€¢ é»æ“Šã€Œé–‹å§‹ä½¿ç”¨æœƒå“¡æœå‹™ã€é—œé–‰æ­¤é é¢</p>
                                <p>â€¢ æ‚¨å°‡æ”¶åˆ° LINE æ­¡è¿è¨Šæ¯</p>
                                <p>â€¢ æœªä¾†å¯é€éç„¡åç‰›æ’å®˜æ–¹å¸³è™Ÿä½¿ç”¨æœƒå“¡æœå‹™</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // é¡¯ç¤ºéŒ¯èª¤ç•«é¢
        function showError(title, message) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-gray-100">
                    <div class="text-center fade-in max-w-md mx-4">
                        <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-exclamation-triangle text-red-600 text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-red-700 mb-4">${title}</h2>
                        <p class="text-gray-600 mb-6 leading-relaxed">${message}</p>
                        <div class="space-y-3">
                            <button onclick="location.reload()" class="w-full bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition duration-300 font-semibold">
                                <i class="fa fa-refresh mr-2"></i>é‡æ–°å˜—è©¦
                            </button>
                            <button onclick="closeLiff()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition duration-300">
                                é—œé–‰é é¢
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // é—œé–‰ LIFF æ‡‰ç”¨
        function closeLiff() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            initializeLiff();
        });

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', (event) => {
            console.error('ğŸ’¥ å…¨åŸŸéŒ¯èª¤:', event.error);
        });
    </script>
</body>
</html>
