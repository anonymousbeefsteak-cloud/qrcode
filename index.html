<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2O LIFF App - 加入好友並記錄</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; }
        #status { margin-top: 20px; font-weight: bold; color: #333; }
        button { padding: 10px 20px; background-color: #00B900; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background-color: gray; cursor: not-allowed; }
        .info { font-size: 0.9em; color: #666; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>歡迎加入無名牛排 LINE 好友</h1>
    <p>掃描 QR Code 加入好友後，點擊按鈕記錄您的 LINE 資訊。</p>
    <button id="submitBtn" onclick="sendToSheet()" disabled>記錄我的資訊</button>
    <div id="status"></div>
    <div class="info">請在 LINE App 內操作。若未加入好友，請先確認加入。</div>

    <script>
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2008276630-bYNjwMx7' });
                if (!liff.isInClient()) {
                    document.getElementById('status').textContent = '請在 LINE App 內掃描 QR Code 開啟此頁面。';
                    return;
                }
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                } else {
                    // 自動取得用戶資料並提交（無需手動點擊）
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('status').textContent = '初始化成功！正在自動記錄您的資料...';
                    await sendToSheet(); // 自動執行提交
                }
            } catch (error) {
                document.getElementById('status').textContent = '初始化失敗: ' + error.message + '。請確保 LIFF 設定正確並在 LINE App 內。';
            }
        }

        async function sendToSheet() {
            try {
                const profile = await liff.getProfile();
                const data = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl,
                    statusMessage: profile.statusMessage || ''
                };

                const response = await fetch('https://script.google.com/macros/s/AKfycbwGaufjpFizvjNjZnXRnOx01bNXUP6IG4697SAkeh06_qAfyVULZ1JdfFtlWVOxzo30gw/exec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    mode: 'no-cors'
                });

                document.getElementById('status').textContent = '您的 LINE User ID 已成功記錄到 Google Sheet！感謝加入。';
                setTimeout(() => liff.closeWindow(), 2000); // 2秒後關閉
            } catch (error) {
                document.getElementById('status').textContent = '記錄失敗: ' + error.message + '。請再試一次。';
            }
        }

        window.onload = initializeLiff;
    </script>
</body>
</html>
